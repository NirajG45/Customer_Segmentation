<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Segmentation</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Customer Segmentation Results</h1>
        <img src="/{{ image }}" alt="Cluster Plot">

        <h2>Cluster Table</h2>
        <div class="table-container">
            {{ tables|safe }}
        </div>

        <a class="download-btn" href="/download">Download CSV</a>

        <h2>Cluster Distribution</h2>
        <canvas id="clusterChart" width="400" height="200"></canvas>

        <h2>Average Income by Cluster</h2>
        <canvas id="incomeChart" width="400" height="200"></canvas>

        <h2>Spending vs Age Scatter by Cluster</h2>
        <canvas id="scatterChart" width="400" height="200"></canvas>
    </div>

    <script>
        const clusterCounts = JSON.parse('{{ cluster_counts | tojson | safe }}');
        const incomeData = JSON.parse('{{ income_by_cluster | tojson | safe }}');
        const scatterPoints = JSON.parse('{{ scatter_data | tojson | safe }}');

        const clusterChart = new Chart(document.getElementById('clusterChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(clusterCounts),
                datasets: [{
                    label: 'Number of Customers',
                    data: Object.values(clusterCounts),
                    backgroundColor: 'rgba(0, 255, 213, 0.5)',
                    borderColor: 'rgba(0, 255, 213, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const incomeChart = new Chart(document.getElementById('incomeChart'), {
            type: 'line',
            data: {
                labels: Object.keys(incomeData),
                datasets: [{
                    label: 'Avg Annual Income (k$)',
                    data: Object.values(incomeData),
                    fill: false,
                    borderColor: 'rgba(255, 221, 87, 1)',
                    backgroundColor: 'rgba(255, 221, 87, 0.5)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        const scatterChart = new Chart(document.getElementById('scatterChart'), {
            type: 'scatter',
            data: {
                datasets: [...new Set(scatterPoints.map(p => p[2]))].map(clusterId => {
                    return {
                        label: `Cluster ${clusterId}`,
                        data: scatterPoints.filter(p => p[2] === clusterId).map(p => ({ x: p[0], y: p[1] })),
                        backgroundColor: `hsl(${clusterId * 90}, 70%, 60%)`
                    };
                })
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Spending Score vs Age by Cluster'
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Age' } },
                    y: { title: { display: true, text: 'Spending Score (1-100)' } }
                }
            }
        });
    </script>
</body>
</html>
